# План улучшений проекта D&D LAN

Документ фиксирует быстрый аудит проекта и приоритеты улучшений.

## Что уже хорошо
- Сервер имеет автоматические тесты (`node --test`) и они проходят.
- Клиент проходит линтинг (`eslint`).
- Продакшн-сборка клиента и копирование в `server/public` уже настроены.
- В проекте есть базовые security-практики: `helmet`, ограничения размеров payload, проверка origin в dev-режиме.

## Ключевые зоны роста (по приоритету)

## P0 — безопасность и обновление зависимостей
1. **Обновить `express` и транзитивные пакеты**
   - По `npm audit` есть high-уязвимости в цепочке `express`/`body-parser`/`qs`/`path-to-regexp`/`send`.
   - Действия:
     - выполнить `npm --prefix server audit fix`;
     - если не закроет полностью — обновить `express` до безопасной версии вручную и прогнать тесты.

2. **Убрать дублирование и расхождение версий `multer`**
   - Сейчас пакет есть в корне (`^2.x`) и отдельно на сервере (`^1.4.5-lts.1`).
   - Риск: разные ветки API и сложнее сопровождать загрузки файлов.
   - Действия:
     - оставить зависимость только там, где реально используется;
     - унифицировать на одну актуальную версию (предпочтительно v2 после проверки совместимости).

## P1 — надежность и операционка
3. **Добавить health/readiness endpoints**
   - Сейчас старт сервера есть, но явной health/readiness проверки нет.
   - Действия:
     - добавить `/healthz` (жив ли процесс) и `/readyz` (доступна ли БД/файловая подсистема).

4. **Усилить управление процессом и graceful shutdown**
   - Есть фоновые `setInterval`; полезно явно очищать интервалы и закрывать server/db на `SIGTERM`.
   - Действия:
     - добавить обработчики сигналов и корректную остановку для более безопасных обновлений.

5. **Стандартизировать логирование**
   - Сейчас есть `morgan` + `console.error`; для диагностики в проде лучше структурированные логи.
   - Действия:
     - перейти на единый JSON-логгер (например pino/winston), добавить request-id.

## P2 — производительность и UX
6. **Оптимизировать бандл клиента**
   - `vendor-react` заметно крупный (~405 KB raw), общая JS-нагрузка можно уменьшить.
   - Действия:
     - добавить lazy-loading для тяжёлых экранов DM/игрока;
     - проверить неиспользуемые зависимости и икон-паки.

7. **Оптимизация ассетов**
   - Несколько изображений крупные (до ~1.9 MB).
   - Действия:
     - пересжать изображения (WebP/AVIF), использовать responsive-версии для мобильных устройств.

## P3 — качество кода и DX
8. **Покрыть API smoke/e2e сценариями**
   - Unit/integration тесты уже есть, но полезен минимальный e2e happy path (DM login → создание/чтение игровых сущностей).

9. **Добавить единые npm-скрипты качества в root**
   - Например `npm run lint`, `npm run test`, `npm run verify` (lint + test + build) в корневом `package.json`.

10. **Расширить документацию эксплуатации**
    - Добавить раздел: резервное копирование/restore, ротация секретов, обновление без простоя, минимальный чеклист перед сессией.

## Предлагаемый порядок внедрения
- **Спринт 1 (1–2 дня):** P0 + verify pipeline.
- **Спринт 2 (1 день):** health/readiness + graceful shutdown + структурированные логи.
- **Спринт 3 (1–2 дня):** бандл/изображения + e2e smoke.

## Definition of Done для улучшений
- Нет high-уязвимостей в `npm audit` для `server`.
- Команда `npm run verify` зелёная локально и в CI.
- Есть `/healthz` и `/readyz` с документированным контрактом.
- Время cold-load клиента и вес основных ассетов снижены и зафиксированы в README.

## UX roadmap для небоевого формата (мнение по предложению)

Ниже — сжатая оценка инициатив, которые дают максимум пользы именно для сюжетной/ролевой партии.

### P0 (первыми)
1. **DM двухпанельный layout (desktop) + список→детали на mobile**
   - Самый быстрый паттерн для мастера: меньше переключений контекста при работе с Players/Bestiary/InfoBlocks/Inventory.
2. **Единая шапка с operational-данными**
   - Название сессии, статус сервера, join-link/copy, online/idle/offline — это базовый контроль сессии “в одном месте”.
3. **Контекстное меню `…` и URL-фильтры**
   - Быстрые действия на карточках + фильтры, которые не сбрасываются при reload/share ссылки.

### P1 (следом)
4. **Player mobile-first navigation**
   - Нижняя навигация (Home/Inventory/Notes/Info/Settings), крупные tap-зоны, skeleton-состояния для списков.
5. **Информационная иерархия карточек**
   - Бейджи статусов, роль, last-active, единый шаблон карточек сущностей (title + 1–2 метки + краткое описание + `…`).
6. **LAN UX-блок подключения**
   - IP + QR + join-code + подсказка по сети; на стороне игрока — экран переподключения с понятным текстом.

### P2 (после стабилизации)
7. **DM-only event log (50–200 записей)**
   - Ускоряет разбор “что произошло” и ведение хроники партии.
8. **Режим “Показ игрокам” для InfoBlocks**
   - Быстрый общий фокус на сцене/улике без ручных пересылок каждому игроку.
9. **Лёгкая дизайн-система (8pt/типографика/акцент)**
   - Повышает цельность UI и снижает стоимость дальнейших изменений.

### Быстрый пакет на 2–4 часа (high impact)
- DM: двухпанельный layout + `…`-меню на карточках.
- Player: нижняя навигация + быстрые действия в инвентаре.
- Общие списки: skeleton + empty + error состояния.

